#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the example service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

# Declare variables
declare log_level

export OTA_GITHUB_REPO="$(bashio::config 'ota_github_repo')"
export OTA_GITHUB_TOKEN="$(bashio::config 'ota_github_token')"
export GITHUB_TOKEN="$(bashio::config 'github_token')"
export OTA_STORAGE_DIR="$(bashio::config 'ota_storage_dir')"
export OTA_HOST_IPV4="$(bashio::config 'ota_host_ipv4')"
export OTA_HTTP_PORT="$(bashio::config 'ota_http_port')"
export OTA_POLL_INTERVAL_SECS="$(bashio::config 'ota_poll_interval_secs')"


export MQTT_BROKER_HOST="$(bashio::services mqtt "host")"
export MQTT_USERNAME="$(bashio::services mqtt "username")"
export MQTT_PASSWORD="$(bashio::services mqtt "password")"
export MQTT_CLIENT_ID="$(bashio::config 'mqtt_client_id')"
export MQTT_KEEP_ALIVE_SECS="$(bashio::config 'mqtt_keep_alive_secs')"

echo "MQTT_BROKER_HOST: ${MQTT_BROKER_HOST}"
echo "MQTT_USERNAME: ${MQTT_USERNAME}"

if bashio::config.has_value 'log_level'; then
    export RUST_LOG="$(bashio::config 'log_level')"
fi

bashio::log.info "${message:="Starting server..."}"

## Run the tool
exec /usr/bin/spotify-frame
